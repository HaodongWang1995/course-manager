# 需求：学生提交作业

## 基本信息
- **状态**：已完成
- **优先级**：P0
- **创建日期**：2026-02-24
- **最后更新**：2026-02-24

## 需求描述

学生在作业页面可以点击「Submit」提交作业，提交时可选上传一个附件（复用现有 R2/本地上传能力）。教师在课程详情页的作业区域可以看到每个作业的提交统计，hover 数字时弹出 Tooltip 显示对应学生姓名。

### 学生端
- 作业卡片有「Submit Assignment」按钮
- 点击后可选上传文件（复用 FileUploadZone）
- 提交后状态变为 Submitted，按钮变为已提交状态

### 教师端
- 作业列表每项显示「X/Y submitted」
- hover 已提交数字 → Tooltip 显示已提交学生姓名
- hover 未提交数字 → Tooltip 显示未提交学生姓名

## 验收标准

- [x] 学生作业卡片有「Submit Assignment」按钮，点击后状态变为 Submitted
- [x] 提交时可选上传文件（复用 FileUploadZone），文件存储到 R2/本地
- [x] 已提交的作业显示 Submitted 状态，按钮变为禁用或显示「已提交」
- [x] 教师端作业列表每项显示「X/Y submitted」（X 已提交，Y 总选课人数）
- [x] hover 已提交数字时 Tooltip 显示已提交学生姓名列表
- [x] hover 未提交数字时 Tooltip 显示未提交学生姓名列表
- [x] i18n 覆盖所有新增文案（中/英）

## 实现方案

### 现状分析

| 模块 | 状态 | 说明 |
|------|------|------|
| assignment_submissions 表 | ✅ 已存在 | 但缺少附件关联字段 |
| PATCH /api/assignments/:id/submit | ✅ 已存在 | 只更新状态，不支持文件 |
| 学生端提交 UI | ⚠️ 部分 | 有状态按钮但无文件上传 |
| 教师端查看提交 | ❌ 不存在 | 无提交统计和学生名单 |
| attachments 系统 | ✅ 完整 | R2 + 本地 stub 模式 |

### 数据库变更

新增迁移 `apps/api/sql/005_submission_attachments.sql`：

```sql
-- 为 assignment_submissions 添加附件关联
ALTER TABLE assignment_submissions
  ADD COLUMN IF NOT EXISTS attachment_id UUID REFERENCES attachments(id) ON DELETE SET NULL;

-- 扩展 attachments 表支持 submission 关联
ALTER TABLE attachments
  DROP CONSTRAINT IF EXISTS attachment_has_parent;

ALTER TABLE attachments
  ADD COLUMN IF NOT EXISTS submission_id UUID REFERENCES assignment_submissions(id) ON DELETE CASCADE;

ALTER TABLE attachments
  ADD CONSTRAINT attachment_has_parent CHECK (
    course_id IS NOT NULL OR schedule_id IS NOT NULL OR submission_id IS NOT NULL
  );
```

### API 变更

| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| PATCH | `/api/assignments/:id/submit` | Student | 修改：支持附件 file_key（可选） |
| GET | `/api/assignments/:id/submissions` | Teacher（课程所有者） | 新增：获取某作业的所有提交详情（含学生姓名） |

### 涉及文件

**后端：**
- `apps/api/sql/005_submission_attachments.sql` — 新增迁移
- `apps/api/src/routes/assignments.ts` — 修改 submit 端点支持附件；新增 GET submissions 端点
- `apps/api/src/routes/attachments.ts` — presign/upload 支持 submission_id 关联

**前端（学生端）：**
- `apps/web/src/pages/student/assignments/index.tsx` — 重构提交交互，添加文件上传
- `apps/web/src/hooks/use-queries.ts` — 修改 useUpdateAssignmentStatus 支持附件
- `apps/web/src/api/client.ts` — 修改 assignmentApi.submit() 支持附件参数

**前端（教师端）：**
- `apps/web/src/pages/teacher/course-detail/components/assignment-section.tsx` — 添加提交统计 + Tooltip
- `apps/web/src/hooks/use-queries.ts` — 新增 useAssignmentSubmissions hook
- `apps/web/src/api/client.ts` — 新增 assignmentApi.getSubmissions() 方法

**i18n：**
- `apps/web/src/locales/en.json` — 新增 submission 相关 key
- `apps/web/src/locales/zh.json` — 新增 submission 相关 key

## 任务清单

- [x] 数据库：创建 005_submission_attachments.sql 迁移
- [x] 后端：修改 PATCH /api/assignments/:id/submit 支持 file_key 参数
- [x] 后端：新增 GET /api/assignments/:id/submissions 端点
- [x] 后端：attachments presign/upload 支持 submission_id
- [x] 前端：学生作业页添加提交对话框（含 FileUploadZone）
- [x] 前端：提交后状态更新为 Submitted，按钮禁用
- [x] 前端：教师作业区域显示「X/Y submitted」统计
- [x] 前端：hover 数字弹出 Tooltip 显示学生姓名列表
- [x] 前端：新增 useAssignmentSubmissions hook
- [x] i18n：新增提交相关翻译 key
- [x] 测试：为新增/修改的 API 编写集成测试

## 备注

- 学生端前端状态值（todo/in-progress/completed）与后端值（pending/submitted/late/graded）不一致，开发时需统一
- 文件上传复用现有 attachments 基础设施（presign → 直传 R2 → confirm），只需扩展关联字段
- Tooltip 使用项目已有的 `@radix-ui/react-tooltip`（shadcn/ui Tooltip 组件）
