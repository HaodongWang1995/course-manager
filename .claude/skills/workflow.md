---
name: claude-code-workflow
description: 软件开发生命周期工作流技能。根据关键词触发三种模式：需求、开发、回归测试。适用于开发者/高级用户。
---

# Claude Code 项目工作流

## 概述

本技能根据用户给出的关键词，执行固定的项目开发流程。共有三种模式：

| 关键词 | 模式 | 说明 |
|--------|------|------|
| `需求` | 需求模式 | 收集需求、写PRD文档、提交git |
| `开发` | 开发模式 | 读需求、开发功能、测试、部署 |
| `回归测试` | 回归测试模式 | 全量测试、排查问题、更新TODO |

---

## 约定

### 目录结构
- PRD文档：`/PRD/`
- TODO文档：`/TODO/`

### PRD 文件命名规则
```
(状态)-(需求名字)-YYYYMMDD
```
**状态枚举：** `未开始` / `开发中` / `已开发` / `已部署`

**示例：**
- `未开始-用户登录-20260220.md`
- `开发中-上传文件-20260220.md`
- `已开发-支付接口-20260101.md`

### Commit Message 规范
```
<类型>(<范围>): <简短描述>

[可选正文，说明背景或原因]
```

**类型：**
- `feat` – 新功能
- `fix` – 修复bug
- `test` – 添加/修改测试
- `docs` – 文档变更（PRD/TODO）
- `chore` – 构建/部署相关
- `refactor` – 重构代码

**示例：**
- `feat(上传文件): 实现文件上传接口`
- `docs(PRD): 新增上传文件需求文档`
- `fix(上传文件): 修复大文件上传失败问题`
- `test(上传文件): 添加单元测试和e2e测试`

---

## 模式一：需求模式

**触发关键词：** `需求`

### 流程

**步骤 1 — 了解需求**

与用户对话，充分了解需求内容，包括：
- 功能描述
- 目标用户/使用场景
- 验收标准（完成的定义是什么）
- 优先级和截止日期（如有）

提问时保持简洁，逐步引导，不要一次抛出太多问题。

**步骤 2 — 确认需求**

将理解到的需求整理成结构化摘要，向用户确认：
```
【需求确认】
- 功能名称：xxx
- 描述：xxx
- 验收标准：
  1. xxx
  2. xxx
- 状态：未开始

以上内容是否准确？有需要补充或修改的吗？
```

在用户确认后才进行下一步。

**步骤 3 — 创建PRD文件**

1. 检查 `/PRD/` 目录是否存在，不存在则创建。
2. 按命名规则创建文件：`未开始-(需求名字)-YYYYMMDD.md`
3. 文件内容模板：

```markdown
# 需求：{需求名字}

## 基本信息
- **状态**：未开始
- **创建日期**：YYYY-MM-DD
- **最后更新**：YYYY-MM-DD

## 需求描述
{详细描述}

## 验收标准
- [ ] {条件1}
- [ ] {条件2}

## 备注
{其他说明}
```

**步骤 4 — 提交git**

```bash
git add /PRD/
git commit -m "docs(PRD): 新增{需求名字}需求文档"
git push
```

完成后告知用户文件路径和commit信息。

---

## 模式二：开发模式

**触发关键词：** `开发`

### 流程

**步骤 1 — 了解需求**

询问用户要开发哪个需求，或让用户指定PRD文件路径。读取对应的PRD文件，理解需求内容和验收标准。

**步骤 2 — 确认项目基础架构**

分析当前项目，了解：
- 技术栈（语言、框架、依赖）
- 目录结构和代码规范
- 现有功能模块，避免重复实现
- 测试框架（单元测试/e2e测试工具）
- 部署方式（CI/CD、部署命令）

将分析结果简要告知用户，确认理解正确后继续。

**步骤 3 — 开发功能**

根据PRD需求和项目开发规范实现功能：
- 遵循现有代码风格和架构
- 模块化、可维护
- 处理边界情况和错误

**步骤 4 — 编写测试**

为新功能编写：
- **单元测试**：覆盖核心逻辑和边界情况
- **e2e测试**：覆盖主要用户流程

**步骤 5 — 运行新功能测试**

运行刚写的单元测试和e2e测试：
```bash
# 单元测试（Vitest）— 在项目根目录执行
pnpm test -- --reporter=verbose

# 或针对特定包
pnpm --filter @course-manager/api test
pnpm --filter @course-manager/ui test

# E2E 测试（Playwright）— 在 apps/web 目录执行
pnpm playwright test e2e/{功能相关spec}.spec.ts
```

如果测试失败，返回步骤 3 修复后重新向下执行。

**步骤 6 — 运行全量测试**

运行项目所有已有的单元测试和e2e测试：
```bash
# 全量单元/集成测试
pnpm test

# 全量 E2E 测试（在 apps/web 目录）
pnpm playwright test
```

如果发现问题，返回步骤 3 修复后重新向下执行。

**步骤 7 — 更新需求状态**

将PRD文件状态从 `开发中` 更新为 `已开发`：
1. 重命名文件：`已开发-(需求名字)-YYYYMMDD.md`
2. 更新文件内的状态字段和最后更新日期
3. 勾选已完成的验收标准

**步骤 8 — 提交git**

```bash
git add .
git commit -m "feat({需求名字}): {简短描述实现内容}

- 实现了xxx
- 添加了单元测试和e2e测试"
git push
```

**步骤 9 — 部署**

本项目部署到 **EC2 (us-west-2, IP: 16.144.22.5)** via Docker Compose：

```bash
# 1. 构建并推送到 EC2
scp docker-compose.prod.yml ec2-user@16.144.22.5:~/course-manager/
ssh -i ~/.ssh/course-manager-key.pem ec2-user@16.144.22.5 \
  "cd ~/course-manager && docker-compose -f docker-compose.prod.yml up -d --build"

# 2. 如有新的 DB 迁移，在 EC2 上执行
cat apps/api/sql/00X_xxx.sql | ssh -i ~/.ssh/course-manager-key.pem ec2-user@16.144.22.5 \
  "docker exec -i course-manager-postgres-1 psql -U postgres -d coursemanager"

# 3. 验证部署
curl http://16.144.22.5/api/health
```

**注意事项：**
- t2.micro 内存有限，如 docker build 失败（ENOSPC），先运行 `docker builder prune -af` 释放缓存
- 不要用 `sed` 修改 EC2 上的 YAML 文件，改用 `scp` 覆盖

部署完成后更新PRD状态为 `已部署`，并重命名文件。

---

## 模式三：回归测试模式

**触发关键词：** `回归测试`

### 流程

**步骤 1 — 运行全量测试**

运行所有单元测试和e2e测试：
```bash
# 全量单元/集成测试（Vitest，项目根目录）
pnpm test

# E2E 测试（Playwright，apps/web 目录）
pnpm playwright test
```

记录测试结果：通过数量、失败数量、失败的测试名称。

**步骤 2 — 分析失败原因**

对于每个失败的测试：
- 查看错误信息和堆栈
- 定位问题代码
- 分析根本原因（是代码bug、测试用例过期、还是环境问题）

**步骤 3 — 关联历史需求**

打开 `/PRD/` 目录，按文件修改时间**从新到旧**排序，逐一检查：
- 该需求是否涉及当前失败的功能点
- 是否有功能冲突或覆盖

将相关需求文件列出，说明关联关系。

**步骤 4 — 记录问题到TODO**

将发现的问题写入 `/TODO/` 文档（如不存在则创建 `/TODO/TODO.md`）：

```markdown
## [{日期}] 回归测试发现问题

### 问题：{问题简述}
- **关联需求**：{PRD文件名}（如有）
- **失败测试**：{测试名称}
- **错误信息**：{简短错误描述}
- **状态**：待修复
```

**步骤 5 — 提交文档改动**

```bash
git add /PRD/ /TODO/
git commit -m "docs(回归测试): 记录回归测试问题 {日期}"
git push
```

**步骤 6 — 询问是否修复**

向用户展示问题列表，询问：
```
【回归测试完成】
发现 {N} 个问题，已记录到 /TODO/TODO.md

问题列表：
1. {问题1}（关联需求：xxx）
2. {问题2}

是否现在开始修复这些问题？（可指定修复某个）
```

如用户确认，进入开发模式针对具体问题进行修复。

---

## 注意事项

- 每个步骤完成后，简要告知用户进度，保持透明。
- 遇到不确定的情况（如部署方式、测试命令），先读取项目文件再执行，不要猜测。
- 所有git操作前确认工作目录干净（`git status`），避免误提交。
- 如果用户提供的关键词不明确，礼貌询问确认是哪种模式。
